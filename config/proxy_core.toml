# SQL Proxy â€” Core Exercise Configuration
#
# This config enables ONLY the 6 core requirements from the take-home exercise:
#   1. SQL Analysis (DDL/DML/SELECT)
#   2. Source Table Access Policies (ALLOW/BLOCK)
#   3. User Management
#   4. Query Execution
#   5. Data Classification (PII.Email, PII.Phone)
#   6. Audit Logging
#
# Run with:  docker compose --profile core up
# Full mode: docker compose up

[server]
host = "0.0.0.0"
port = 8080
threads = 4
request_timeout_ms = 30000
max_sql_length = 102400

[logging]
level = "info"
file = "/app/logs/proxy.log"

# ============================================================================
# Database Connection
# ============================================================================

[[databases]]
name = "testdb"
type = "postgresql"
connection_string = "postgresql://proxy_user:secure_password@postgres:5432/testdb"
min_connections = 2
max_connections = 10
connection_timeout_ms = 5000
query_timeout_ms = 30000
health_check_query = "SELECT 1"
health_check_interval_seconds = 10
idle_timeout_seconds = 300
pool_acquire_timeout_ms = 5000
max_result_rows = 10000

# ============================================================================
# Users and Roles
# ============================================================================

[[users]]
name = "admin"
roles = ["admin"]
api_key = "sk-admin-key-12345"
description = "Administrator with full access"

[[users]]
name = "analyst"
roles = ["analyst", "readonly"]
api_key = "sk-analyst-key-67890"
description = "Data analyst with read-only access"

[[users]]
name = "developer"
roles = ["developer"]
api_key = "sk-developer-key-abcde"
description = "Developer with DML access"

[[users]]
name = "auditor"
roles = ["auditor", "readonly"]
api_key = "sk-auditor-key-fghij"
description = "Auditor with limited read access"

# ============================================================================
# Access Control Policies
# ============================================================================

# Block all DDL for non-admins
[[policies]]
name = "block_all_ddl"
priority = 100
action = "BLOCK"
users = ["*"]
exclude_roles = ["admin"]
statement_types = ["CREATE_TABLE", "ALTER_TABLE", "DROP_TABLE", "CREATE_INDEX", "DROP_INDEX", "TRUNCATE"]
reason = "DDL operations require admin role"

# Block access to sensitive_data for non-auditors
[[policies]]
name = "block_sensitive_data"
priority = 90
action = "BLOCK"
users = ["*"]
exclude_roles = ["auditor", "admin"]
database = "testdb"
schema = "public"
table = "sensitive_data"
statement_types = ["SELECT", "INSERT", "UPDATE", "DELETE"]
reason = "Sensitive data table requires auditor or admin role"

# Block writes for readonly roles
[[policies]]
name = "block_writes_readonly"
priority = 80
action = "BLOCK"
roles = ["readonly"]
statement_types = ["INSERT", "UPDATE", "DELETE"]
reason = "Read-only role cannot perform write operations"

# Allow analysts to read customers, orders, order_items
[[policies]]
name = "allow_analyst_read_customers"
priority = 50
action = "ALLOW"
roles = ["analyst"]
database = "testdb"
schema = "public"
table = "customers"
statement_types = ["SELECT"]

[[policies]]
name = "allow_analyst_read_orders"
priority = 50
action = "ALLOW"
roles = ["analyst"]
database = "testdb"
schema = "public"
table = "orders"
statement_types = ["SELECT"]

[[policies]]
name = "allow_analyst_read_order_items"
priority = 50
action = "ALLOW"
roles = ["analyst"]
database = "testdb"
schema = "public"
table = "order_items"
statement_types = ["SELECT"]

# Allow developers read + write on customers, orders, order_items
[[policies]]
name = "allow_developer_customers"
priority = 50
action = "ALLOW"
roles = ["developer"]
database = "testdb"
schema = "public"
table = "customers"
statement_types = ["SELECT", "INSERT", "UPDATE"]

[[policies]]
name = "allow_developer_orders"
priority = 50
action = "ALLOW"
roles = ["developer"]
database = "testdb"
schema = "public"
table = "orders"
statement_types = ["SELECT", "INSERT", "UPDATE", "DELETE"]

[[policies]]
name = "allow_developer_order_items"
priority = 50
action = "ALLOW"
roles = ["developer"]
database = "testdb"
schema = "public"
table = "order_items"
statement_types = ["SELECT", "INSERT", "UPDATE", "DELETE"]

# Allow auditors to read sensitive_data
[[policies]]
name = "allow_auditor_sensitive"
priority = 60
action = "ALLOW"
roles = ["auditor"]
database = "testdb"
schema = "public"
table = "sensitive_data"
statement_types = ["SELECT"]

# Allow admins full access
[[policies]]
name = "allow_admin_all"
priority = 10
action = "ALLOW"
roles = ["admin"]
database = "testdb"
statement_types = ["SELECT", "INSERT", "UPDATE", "DELETE", "CREATE_TABLE", "ALTER_TABLE", "DROP_TABLE", "CREATE_INDEX", "DROP_INDEX", "TRUNCATE"]

# Default deny
[[policies]]
name = "default_deny"
priority = 1
action = "BLOCK"
users = ["*"]
reason = "Default deny - no matching policy"

# ============================================================================
# PII Classification (required: PII.Email, PII.Phone)
# ============================================================================

[[classifiers]]
type = "PII.Email"
strategy = "column_name"
patterns = ["email", ".*_email$", "email_.*", "mail"]
data_validation_regex = "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
sample_size = 20
confidence_threshold = 0.8

[[classifiers]]
type = "PII.Phone"
strategy = "column_name"
patterns = ["phone", ".*_phone$", "phone_.*", "mobile", "cell", "telephone"]
data_validation_regex = "^[+]?[(]?[0-9]{1,4}[)]?[-\\s\\.]?[(]?[0-9]{1,4}[)]?[-\\s\\.]?[0-9]{1,9}$"
sample_size = 20
confidence_threshold = 0.8

# ============================================================================
# Audit Logging
# ============================================================================

[audit]
enabled = true
async_mode = true
ring_buffer_size = 65536
flush_interval_ms = 100
max_batch_size = 1000
fsync_interval_batches = 10

[audit.file]
enabled = true
output_file = "/app/logs/audit.jsonl"
rotation_size_mb = 100
max_files = 10

# ============================================================================
# Minimal infrastructure (required for stable operation)
# ============================================================================

[rate_limiting]
enabled = true

[rate_limiting.global]
tokens_per_second = 50000
burst_capacity = 10000

[rate_limiting.per_user_default]
tokens_per_second = 1000
burst_capacity = 200

[cache]
enabled = true
max_entries = 10000
num_shards = 16
ttl_seconds = 300

[circuit_breaker]
enabled = true
failure_threshold = 10
success_threshold = 5
timeout_ms = 60000
half_open_max_calls = 3
